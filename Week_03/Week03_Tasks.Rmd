---
title: "Week 3 Tasks — Data Preparation, EDA, and Intro Modeling (R)"
author: "Cao Pham Minh Dang"
output:
  pdf_document: default
editor_options:
  chunk_output_type: inline
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(patchwork)
library(dplyr)       # only dplyr
library(DataExplorer)
theme_set(theme_minimal())
```

# Instructions

- Use this template to complete Week 3 tasks. Replace placeholders with your work.
- Ensure the document can knit top-to-bottom without errors.
- Add short captions/annotations below each plot and metric output.

# Task 1 — Load Data and Inspect

```{r load-data}
data <- read.csv("./ncr_ride_bookings.csv", na = c("", "NA", "null"))
print(dim(data))

summary(data)

head(data, 10)

```

## **Briefly describe the dataset, its purpose, and key variables.**
  **Overview**
  This comprehensive dataset contains detailed ride-sharing data from Uber operations for the year 2024.

The dataset contains 150,000 Uber ride bookings in the NCR region, with each row representing a single ride booking event.
Its purpose is to provide detailed analytics on ride bookings, cancellations, completions, and customer/driver interactions.

**Key variables:**
  - `Date`, `Time`: When the booking was made.
- `Booking ID`, `Customer ID`: Unique identifiers for each booking and customer.
- `Booking Status`: Status of the ride (e.g., Completed, Incomplete, No Driver Found).
- `Vehicle Type`: Type of vehicle booked.
- `Pickup Location`, `Drop Location`: Start and end points of the ride.
- `Avg VTAT` (Vehicle Turnaround Time), `Avg CTAT` (Customer Turnaround Time): Operational metrics.
- `Cancelled Rides by Customer/Driver`, `Reason for cancelling by Customer/Driver`: Cancellations and their reasons.
- `Incomplete Rides`, `Incomplete Rides Reason`: Rides that were not completed and why.
- `Booking Value`: Fare amount for the ride.
- `Ride Distance`: Distance covered in the ride.
- `Driver Ratings`, `Customer Rating`: Feedback scores.
- `Payment Method`: How the ride was paid for (e.g., UPI, Debit Card).

**Purpose**
  The primary purpose of this dataset is to enable in-depth analysis of Uber’s ride-hailing operations within the NCR region during 2024. By capturing every stage of the ride lifecycle, from booking to completion or cancellation, it provides a foundation for answering both operational and strategic questions. Therefore, this data can offer rich insights into booking patterns, vehicle performance, revenue streams, cancellation behaviors, and customer satisfaction metrics.

# Task 2 — Data Types, Summary Stats, and Missingness

```{r types-summary-missing}
# Glimpse types
glimpse(data)

# Summary statistics (numeric and categorical)
summary(data)

# Missingness per column
tibble(col = names(data), n_missing = colSums(is.na(data))) %>%
  mutate(p_missing = n_missing / nrow(data)) %>%
  arrange(desc(p_missing))
```

# Task 3 — Data Cleaning

```{r cleaning}
# Standardize column names → snake_case
names(data) <- names(data) %>%
  tolower() %>% 
  str_trim() %>%
  str_replace_all("[^a-z0-9]+", "_") %>%   # replace any sequence of non-alphanumeric chars with "_"
  str_replace_all("^_|_$", "")             # remove leading/trailing underscores


# Remove duplicates
data <- data %>%
  distinct()

# Handle missing values 
data <- data %>%
  mutate(across(where(is.character), ~replace_na(., "Unknown"))) %>%
  mutate(across(where(is.numeric), ~replace_na(., median(., na.rm = TRUE))))
```
## **Data Cleaning Decisions**

1. **Missing Values**
   - Treated `""`, `"NA"`, and `"null"` as missing.  
   - For categorical variables → replaced missing with `"Unknown"` to preserve information.  
   - For numeric variables → imputed missing values with the **median** to avoid skewness compared to mean imputation.  

2. **Duplicates**
   - Removed duplicate rows using `distinct()` to prevent overcounting rides.  

3. **Column Names**
   - Standardized column names to **snake_case** (e.g., `Booking.ID` → `booking_id`) for consistency in coding and readability.  

# Task 4 — Exploratory Data Analysis (EDA)

```{r eda}
# Full EDA plotting script (no conditionals) ----
library(ggplot2)
library(cowplot)    # plot_grid()
library(forcats)    # fct_infreq()
library(dplyr)

# Dataframe: `data` is expected to exist in the environment.

# 1) Univariate distributions + boxplots for numeric columns
numeric_cols <- c("avg_vtat", "avg_ctat", "booking_value",
                  "ride_distance", "driver_ratings", "customer_rating")

for (col in numeric_cols) {
  # histogram with density overlay (density scale)
  p_hist <- ggplot(data, aes_string(x = col)) +
    geom_histogram(aes(y = ..density..),
                   bins = 30, fill = "steelblue", color = "black", alpha = 0.7) +
    geom_density(alpha = 0.35, size = 0.8) +
    labs(title = paste("Distribution of", col),
         x = col, y = "Density") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12, face = "bold"))
  
  # horizontal boxplot
  p_box <- ggplot(data, aes_string(x = "1", y = col)) +
    geom_boxplot(fill = "orange", alpha = 0.8, outlier.size = 1) +
    coord_flip() +
    labs(title = paste("Boxplot of", col),
         x = "", y = col) +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          plot.title = element_text(size = 12, face = "bold"))
  
  # side-by-side with relative widths like the original (3:1)
  print(plot_grid(p_hist, p_box, nrow = 1, rel_widths = c(3, 1)))
}

# 2) Pair scatterplots: Booking Value vs Ride Distance & Driver Ratings vs Customer Rating
p_scatter_ride_booking <- ggplot(data, aes(x = ride_distance, y = booking_value)) +
  geom_point(alpha = 0.3) +
  labs(title = "Booking Value vs Ride Distance",
       x = "Ride Distance", y = "Booking Value") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

p_scatter_driver_customer <- ggplot(data, aes(x = driver_ratings, y = customer_rating)) +
  geom_point(alpha = 0.3) +
  labs(title = "Driver Ratings vs Customer Rating",
       x = "Driver Ratings", y = "Customer Rating") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

print(plot_grid(p_scatter_ride_booking, p_scatter_driver_customer, nrow = 1))

# 3) Categorical distributions: Booking Status and Vehicle Type (ordered by frequency)
p_booking_status <- ggplot(data %>% mutate(booking_status = fct_infreq(booking_status)),
                           aes(x = booking_status)) +
  geom_bar() +
  labs(title = "Distribution of Booking Status", x = "Booking Status", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        plot.title = element_text(face = "bold"))

p_vehicle_type <- ggplot(data %>% mutate(vehicle_type = fct_infreq(vehicle_type)),
                         aes(x = vehicle_type)) +
  geom_bar() +
  labs(title = "Distribution of Vehicle Type", x = "Vehicle Type", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        plot.title = element_text(face = "bold"))

print(plot_grid(p_booking_status, p_vehicle_type, nrow = 1))

# 4) Repeat the scatterplots (explicitly matching the Python block that creates separate figure)
# (keeps parity with your original script which shows these twice)
p_scatter_ride_booking2 <- ggplot(data, aes(x = ride_distance, y = booking_value)) +
  geom_point(alpha = 0.3) +
  labs(title = "Booking Value vs Ride Distance", x = "Ride Distance", y = "Booking Value") +
  theme_minimal()

p_scatter_driver_customer2 <- ggplot(data, aes(x = driver_ratings, y = customer_rating)) +
  geom_point(alpha = 0.3) +
  labs(title = "Driver Ratings vs Customer Rating", x = "Driver Ratings", y = "Customer Rating") +
  theme_minimal()

print(plot_grid(p_scatter_ride_booking2, p_scatter_driver_customer2, nrow = 1))

# 5) Repeat the categorical count plots (explicit parity with Python)
p_booking_status2 <- ggplot(data %>% mutate(booking_status = fct_infreq(booking_status)),
                            aes(x = booking_status)) +
  geom_bar() +
  labs(title = "Distribution of Booking Status", x = "Booking Status", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

p_vehicle_type2 <- ggplot(data %>% mutate(vehicle_type = fct_infreq(vehicle_type)),
                          aes(x = vehicle_type)) +
  geom_bar() +
  labs(title = "Distribution of Vehicle Type", x = "Vehicle Type", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

print(plot_grid(p_booking_status2, p_vehicle_type2, nrow = 1))

# 6) Boxplot: Booking Value by Payment Method
p_payment_box <- ggplot(data, aes(x = payment_method, y = booking_value)) +
  geom_boxplot(outlier.size = 0.8) +
  labs(title = "Booking Value by Payment Method",
       x = "Payment Method", y = "Booking Value") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        plot.title = element_text(face = "bold"))

print(p_payment_box)


```

## **Write 3–5 short observations from EDA here.**
- **Customer Satisfaction:** The majority of customers provide an average driver rating of 4.5 stars, reflecting a consistently high level of satisfaction with ride experiences.

- **Cancellations:** Driver-initiated cancellations (~25,000) significantly exceed customer-initiated cancellations (~10,000). This points to supply-side challenges such as inadequate incentives, route mismatches, or operational constraints (e.g., traffic conditions).

- **Pricing Dynamics:** Booking values exhibit high variability even at comparable ride distances, suggesting that fare determination is influenced by multiple factors beyond distance alone, including vehicle type, surge pricing, and demand-supply dynamics.

# Task 5 — Data Visualization

```{r viz}
# --- Plot 1: Booking Status distribution ---
p1 <- ggplot(data, aes(x = booking_status)) +
  geom_bar(fill = "steelblue") +
  scale_x_discrete(limits = names(sort(table(data$booking_status), decreasing = TRUE))) +
  labs(
    title = "Distribution of Booking Status",
    x = "Booking Status",
    y = "Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

print(p1)

# --- Plot 2: Booking Value by Payment Method ---

# Histogram of Customer Rating
p2 <- ggplot(data, aes(x = customer_rating)) +
  geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Customer Rating",
    x = "Customer Rating",
    y = "Count"
  ) +
  theme_minimal()

# Boxplot of Customer Rating
p3 <- ggplot(data, aes(y = customer_rating)) +
  geom_boxplot(fill = "lightblue") +
  labs(
    title = "Customer Rating Boxplot",
    y = "Customer Rating"
  ) +
  theme_minimal()

# Combine plots side by side
plot_grid(p2, p3, labels = c("A", "B"))

```

**Key takeaway 1:** Driver cancelations significantly exceeds customer cancelations. This points to supply-side challenges such as inadequate incentives, route mismatches, or operational constraints (e.g., traffic conditions). 

**Key takeaway 2:** Most customers assign drivers an average rating of 4.5 stars, indicating a consistently high level of satisfaction and a strong overall service experience.
  
  
  